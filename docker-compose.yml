version: '3.8'

services:
  # Load Balancer
  load-balancer:
    build: .
    container_name: load-balancer
    ports:
      - "8080:8080"
    environment:
      - HTTP_ADDR=:8080
      - LOG_LEVEL=info
      - ENV=production
      - STRATEGY=round-robin
      - HEALTH_CHECK_INTERVAL=5s
      - BACKENDS=http://backend1:8081,http://backend2:8082,http://backend3:8083
    depends_on:
      - backend1
      - backend2
      - backend3
    networks:
      - loadbalancer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # Backend Server 1
  backend1:
    image: hashicorp/http-echo
    container_name: backend1
    command:
      - -text=Backend Server 1
      - -listen=:8081
    ports:
      - "8081:8081"
    networks:
      - loadbalancer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Backend Server 2
  backend2:
    image: hashicorp/http-echo
    container_name: backend2
    command:
      - -text=Backend Server 2
      - -listen=:8082
    ports:
      - "8082:8082"
    networks:
      - loadbalancer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Backend Server 3
  backend3:
    image: hashicorp/http-echo
    container_name: backend3
    command:
      - -text=Backend Server 3
      - -listen=:8083
    ports:
      - "8083:8083"
    networks:
      - loadbalancer-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

networks:
  loadbalancer-network:
    driver: bridge
